<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>atom</title>
  <style>*{margin:0;padding:0;box-sizing:border-box}:root{--bg:#09090b;--card:#18181b;--border:#27272a;--text:#fafafa;--muted:#a1a1aa;--primary:#f4f4f5;--hover:#27272a}body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}a{color:var(--text);text-decoration:none;transition:color .2s}a:hover{color:var(--muted)}.btn{padding:.5rem 1rem;border-radius:.375rem;font-size:.875rem;font-weight:500;transition:all .2s;border:1px solid transparent}.btn-ghost{background:transparent;border-color:transparent}.btn-ghost:hover{background:var(--hover)}.btn-outline{border-color:var(--border);background:transparent}.btn-outline:hover{background:var(--hover)}.btn-primary{background:var(--primary);color:var(--bg)}.btn-primary:hover{opacity:.9}header{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;border-bottom:1px solid var(--border);background:var(--bg)}.logo{display:flex;align-items:center;gap:.5rem;font-size:1.25rem;font-weight:600}.logo svg{width:1.5rem;height:1.5rem}nav{display:flex;gap:.5rem;align-items:center}.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;place-items:center;z-index:50}.modal.active{display:grid}.modal-content{background:var(--card);border:1px solid var(--border);border-radius:.5rem;padding:1.5rem;max-width:28rem;width:90%;position:relative}.modal-close{position:absolute;top:.75rem;right:.75rem;background:none;border:none;color:var(--muted);cursor:pointer;padding:.25rem}.modal-close:hover{color:var(--text)}.modal h2{font-size:1.25rem;margin-bottom:.75rem}.modal p{color:var(--muted);font-size:.875rem;margin-bottom:.5rem}textarea{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:.375rem;padding:.75rem;color:var(--text);font-family:inherit;min-height:100px;margin-bottom:1rem;resize:vertical}textarea:focus{outline:none;border-color:var(--text)}.toast-container{position:fixed;bottom:1.5rem;right:1.5rem;z-index:100;display:flex;flex-direction:column;gap:.5rem;pointer-events:none}.toast{background:var(--card);border:1px solid var(--border);padding:1rem;border-radius:.5rem;color:var(--text);animation:slideIn .3s ease;pointer-events:auto;min-width:300px;max-width:400px;word-wrap:break-word;display:flex;align-items:center;justify-content:space-between;gap:.5rem}.toast-success{border-color:#22c55e}.toast-error{border-color:#ef4444}@keyframes slideIn{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}.input-wrapper{position:relative;margin-bottom:1rem}.input-wrapper input{width:100%;background:var(--bg);border:1px solid var(--border);padding:.75rem 2.5rem .75rem 1rem;border-radius:.375rem;color:var(--text);font-size:1rem}.input-wrapper input:focus{outline:none;border-color:var(--text)}.clear-icon{position:absolute;right:.75rem;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--muted);display:none;background:none;border:none}.input-wrapper input:not(:placeholder-shown)+.clear-icon{display:block}.input-wrapper input:disabled+.clear-icon{display:none!important}.password-icon{position:absolute;right:.75rem;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--muted);background:none;border:none;display:flex}.password-icon:hover{color:var(--text)}.auth-hidden{display:none!important}.btn-lg{padding:.75rem;font-size:1rem}.profile-dropdown{position:relative}.avatar{width:2.5rem;height:2.5rem;border-radius:50%;background:var(--primary);color:var(--bg);border:none;font-weight:600;cursor:pointer;display:grid;place-items:center}.dropdown-menu{position:absolute;top:100%;right:0;margin-top:.5rem;background:var(--card);border:1px solid var(--border);border-radius:.5rem;padding:.5rem;display:none;flex-direction:column;gap:.25rem;width:max-content;z-index:100}.dropdown-menu.active{display:flex}.dropdown-menu a{padding:.5rem 1rem;border-radius:.25rem;text-align:left}.dropdown-menu a:hover{background:var(--hover)}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.modal-header h2{margin:0}.switch{position:relative;display:inline-block;width:34px;height:20px}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--border);transition:.4s;border-radius:34px}.slider:before{position:absolute;content:"";height:14px;width:14px;left:3px;bottom:3px;background-color:var(--text);transition:.4s;border-radius:50%}input:checked+.slider{background-color:var(--primary)}input:checked+.slider:before{background-color:var(--bg);transform:translateX(14px)}.login-detail-row{display:flex;justify-content:space-between;align-items:center;padding:.75rem 0;border-bottom:1px solid var(--border)}.login-detail-row:last-child{border-bottom:none}.login-detail-label{color:var(--muted);font-size:.875rem}.login-detail-value{font-weight:500;display:flex;align-items:center;gap:.5rem}.login-detail-actions{display:flex;gap:.5rem}</style>
</head>
<body>
  <div id="about-modal" class="modal" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('about-modal').classList.remove('active')">✕</button>
      <h2>About us</h2>
      <p>A minimal social platform built for thoughtful expression. No algorithms, no noise—just pure, unfiltered voices.</p>
      <p>Share your views. Discover perspectives. Connect with minds that matter.</p>
      <p style="color:var(--text);margin-top:1rem;font-size:.75rem">Simple. Open. Human.</p>
    </div>
  </div>
  <div id="support-modal" class="modal" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('support-modal').classList.remove('active')">✕</button>
      <h2>Support</h2>
      <div class="input-wrapper" style="position:relative;margin-bottom:1rem"><textarea id="support-input" placeholder="Describe your issue..." style="margin-bottom:0"></textarea><button class="clear-icon" onclick="document.getElementById('support-input').value=''" style="top:1rem;transform:none">✕</button></div>
      <button class="btn btn-primary" style="width:100%" onclick="submitSupport()">Submit</button>
    </div>
  </div>
  <div id="signup-modal" class="modal" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('signup-modal').classList.remove('active')">✕</button>
      <h2>Sign up</h2>

      <div class="input-wrapper"><input type="text" id="signup-username" placeholder="Username"><button class="clear-icon" onclick="document.getElementById('signup-username').value=''">✕</button></div>
      <div class="input-wrapper"><input type="password" id="signup-password" placeholder="Password"><button class="password-icon" onclick="togglePassword('signup-password',this)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></div>
      <button class="btn btn-primary btn-lg" style="width:100%" onclick="signup()">Submit</button>
    </div>
  </div>
  <div id="login-modal" class="modal" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('login-modal').classList.remove('active')">✕</button>
      <h2>Login</h2>
      <div class="input-wrapper"><input type="text" id="login-username" placeholder="Username"><button class="clear-icon" onclick="document.getElementById('login-username').value=''">✕</button></div>
      <div class="input-wrapper"><input type="password" id="login-password" placeholder="Password"><button class="password-icon" onclick="togglePassword('login-password',this)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></div>
      <button class="btn btn-primary btn-lg" style="width:100%" onclick="login()">Submit</button>
    </div>
  </div>
  <div id="profile-view-modal" class="modal" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="modal-content">

      <div class="modal-header">
        <h2>My Profile</h2>
        <div style="display:flex;gap:.5rem;align-items:center">
          <button id="btn-edit-profile" class="btn btn-primary" style="padding:.25rem .75rem;font-size:.75rem;color:var(--bg);font-weight:700" onclick="toggleEdit()">Edit</button>
          <button id="btn-save-profile" class="btn btn-primary" style="padding:.25rem .75rem;font-size:.75rem;display:none" onclick="saveProfile()">Save</button>
          <button class="modal-close" style="position:static" onclick="document.getElementById('profile-view-modal').classList.remove('active')">✕</button>
        </div>
      </div>
      <p id="profile-joined" style="margin-bottom:1rem;color:var(--muted);font-size:.875rem"></p>
      <div class="input-wrapper"><label style="display:block;margin-bottom:.25rem;color:var(--muted);font-size:.75rem">Name</label><div style="position:relative"><input type="text" id="profile-name" placeholder="Name" disabled><button class="clear-icon" onclick="document.getElementById('profile-name').value=''">✕</button></div></div>
      <div class="input-wrapper"><label style="display:block;margin-bottom:.25rem;color:var(--muted);font-size:.75rem">Country</label><div style="position:relative"><input type="text" id="profile-country" placeholder="Country" disabled><button class="clear-icon" onclick="document.getElementById('profile-country').value=''">✕</button></div></div>
    </div>
  </div>
  <div id="login-details-modal" class="modal" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('login-details-modal').classList.remove('active')">✕</button>
      <h2>Login Details</h2>
      <div id="login-details-container"></div>
    </div>
  </div>
  <div id="delete-account-modal" class="modal" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('delete-account-modal').classList.remove('active')">✕</button>
      <h2>Delete Account</h2>
      <p style="margin-bottom:1.5rem">Are you sure you want to delete your account? This action cannot be undone.</p>
      <div style="display:flex;gap:1rem">
        <button class="btn" style="width:100%;background:white;color:black" onclick="document.getElementById('delete-account-modal').classList.remove('active')">Cancel</button>
        <button class="btn btn-primary" style="width:100%;background-color:#ef4444;border-color:#ef4444;color:white" onclick="deleteAccount()">Delete</button>
      </div>
    </div>
  </div>
  <div id="logout-confirmation-modal" class="modal" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('logout-confirmation-modal').classList.remove('active')">✕</button>
      <h2>Logout</h2>
      <p style="margin-bottom:1.5rem">Are you sure you want to logout?</p>
      <div style="display:flex;gap:1rem">
        <button class="btn" style="width:100%;background:white;color:black" onclick="document.getElementById('logout-confirmation-modal').classList.remove('active')">Cancel</button>
        <button class="btn btn-primary" style="width:100%;background-color:#ef4444;border-color:#ef4444;color:white" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>
  <header>
    <a href="/" class="logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="4.93" y1="4.93" x2="9.17" y2="9.17"/><line x1="14.83" y1="14.83" x2="19.07" y2="19.07"/><line x1="14.83" y1="9.17" x2="19.07" y2="4.93"/><line x1="4.93" y1="19.07" x2="9.17" y2="14.83"/></svg>atom</a>
    <nav>
      <a href="#" class="btn btn-ghost" onclick="document.getElementById('about-modal').classList.add('active');return false">About</a>
      <a href="#" class="btn btn-ghost" onclick="document.getElementById('support-modal').classList.add('active');return false">Support</a>
      <a href="#signup" id="nav-signup" class="btn btn-outline" onclick="document.getElementById('signup-modal').classList.add('active');return false">Sign up</a>
      <a href="#login" id="nav-login" class="btn btn-primary" onclick="document.getElementById('login-modal').classList.add('active');return false">Login</a>
      <div id="nav-profile" class="profile-dropdown auth-hidden">
        <button id="avatar" class="avatar" onclick="document.getElementById('profile-menu').classList.toggle('active')"></button>
        <div id="profile-menu" class="dropdown-menu">
           <a href="#" onclick="viewProfile();return false">View Profile</a>
           <a href="#" onclick="viewLoginDetails();return false">Login Details</a>
           <a href="#" onclick="document.getElementById('delete-account-modal').classList.add('active');return false">Delete Account</a>
           <a href="#" onclick="document.getElementById('logout-confirmation-modal').classList.add('active');return false">Logout</a>
        </div>
      </div>
    </nav>
  </header>
  <div id="toast-container" class="toast-container"></div>
<script>
const API_URL=window.location.origin+"/public/object-create?table=support",
      AUTH_URL=window.location.origin+"/auth/signup-username-password",
      LOGIN_URL=window.location.origin+"/auth/login-password-username",
      PROFILE_URL=window.location.origin+"/my/profile",
      UPDATE_PROFILE_URL=window.location.origin+"/my/object-update?table=users",
      DELETE_ACCOUNT_URL=window.location.origin+"/my/account-delete?mode=hard",
      SHOW_JOINED_DATE=false;

async function submitSupport(){
  const e=document.getElementById("support-input"),t=e.value.trim();
  if(!t)return showToast("Please enter a description","error");
  const token=localStorage.getItem("token");
  const headers={"Content-Type":"application/json"};
  if(token) headers["Authorization"] = "Bearer " + token;
  try{
    const n=await fetch(API_URL,{method:"POST",headers:headers,body:JSON.stringify({description:t})}),o=await n.json();
    200===n.status?(showToast(o.message||"Support request submitted","success"),e.value="",document.getElementById("support-modal").classList.remove("active")):showToast(o.message||"Something went wrong","error")
  }catch(e){showToast("Network error occurred","error")}
}

async function signup(){
  const e=document.getElementById("signup-username").value.trim(),t=document.getElementById("signup-password").value.trim();
  if(!e||!t)return showToast("Please enter username and password","error");
  try{
    const n=await fetch(AUTH_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:1,username:e,password:t})}),o=await n.json();
    if(200===n.status){
      const{token:e}=o.message;
      localStorage.setItem("token",e),await fetchProfile(),checkAuthState(),document.getElementById("signup-modal").classList.remove("active"),showToast("Signup successful","success")
    }else showToast(o.message||"Signup failed","error")
  }catch(e){showToast("Network error occurred","error")}
}

async function login(){
  const e=document.getElementById("login-username").value.trim(),t=document.getElementById("login-password").value.trim();
  if(!e||!t)return showToast("Please enter username and password","error");
  try{
    const n=await fetch(LOGIN_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:1,username:e,password:t})}),o=await n.json();
    if(200===n.status&&1===o.status){
      localStorage.setItem("token",o.message),await fetchProfile(),checkAuthState(),document.getElementById("login-modal").classList.remove("active"),showToast("Login successful","success")
    }else showToast(o.message||"Login failed","error")
  }catch(e){showToast("Network error occurred","error")}
}

async function fetchProfile(){
    const t=localStorage.getItem("token");
    if(!t)return;
    try{
        const n=await fetch(PROFILE_URL,{headers:{"Authorization":"Bearer "+t}}),o=await n.json();
        200===n.status&&1===o.status&&localStorage.setItem("user",JSON.stringify(o.message))
    }catch(e){console.error(e)}
}

function logout(){localStorage.removeItem("token"),localStorage.removeItem("user"),checkAuthState(),document.getElementById("logout-confirmation-modal").classList.remove("active"),showToast("Logged out successfully","success")}

function checkAuthState(){
  const e=localStorage.getItem("token"),t=document.getElementById("nav-signup"),n=document.getElementById("nav-login"),o=document.getElementById("nav-profile");
  if(e){
    t.classList.add("auth-hidden"),n.classList.add("auth-hidden"),o.classList.remove("auth-hidden");
    const u=JSON.parse(localStorage.getItem("user"));
    u&&(document.getElementById("avatar").textContent=u.username.charAt(0).toUpperCase())
  }else{
    t.classList.remove("auth-hidden"),n.classList.remove("auth-hidden"),o.classList.add("auth-hidden")
  }
}

function showToast(e,t="success"){
  const n=document.createElement("div");
  n.className="toast toast-"+t,n.innerHTML='<span></span><button onclick="this.parentElement.remove()" style="background:none;border:none;color:inherit;cursor:pointer;padding:0;display:flex"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>',n.firstChild.textContent=e;
  document.getElementById("toast-container").appendChild(n),setTimeout((()=>n.remove()),3e3)
}

document.addEventListener("DOMContentLoaded",()=>{
    const t=localStorage.getItem("token");
    if(t){fetchProfile().then(checkAuthState);setInterval(fetchProfile,36e5)}
    checkAuthState();
    document.addEventListener("click",(e)=>{
        const m=document.getElementById("profile-menu");
        if(!e.target.closest("#nav-profile")) m.classList.remove("active");
    });
});

function calculateDaysJoined(d){
    if(!d)return 0;
    const j=new Date(d),n=new Date(),diff=Math.abs(n-j);
    return Math.ceil(diff/(1000*60*60*24));
}

function viewProfile(){
    const u=JSON.parse(localStorage.getItem("user"));
    if(!u)return;
    document.getElementById("profile-name").value=u.name||"";
    document.getElementById("profile-country").value=u.country||"";
    
    const d=calculateDaysJoined(u.created_at);

    const joinedEl = document.getElementById("profile-joined");
    if(SHOW_JOINED_DATE){
        joinedEl.textContent=`Joined ${d} days ago`;
        joinedEl.style.display="block";
    }else{
        joinedEl.style.display="none";
    }
    
    document.getElementById("btn-edit-profile").style.display="block";
    document.getElementById("btn-save-profile").style.display="none";
    ["profile-name","profile-country"].forEach(id=>document.getElementById(id).disabled=true);
    
    document.getElementById("profile-view-modal").classList.add("active");
    document.getElementById("profile-menu").classList.remove("active");
}

function toggleEdit(){
    document.getElementById("btn-edit-profile").style.display="none";
    document.getElementById("btn-save-profile").style.display="block";
    ["profile-name","profile-country"].forEach(id=>document.getElementById(id).disabled=false);
}

async function saveProfile(){
    const u=JSON.parse(localStorage.getItem("user")),t=localStorage.getItem("token");
    if(!u||!t)return;
    
    const inputData = {
        name: document.getElementById("profile-name").value.trim(),
        country: document.getElementById("profile-country").value.trim()
    };
    
    // Construct payload with only changed fields plus ID
    const upd = { id: u.id };
    let hasChanges = false;
    
    for (const key in inputData) {
        if (inputData[key] !== (u[key] || "")) {
            upd[key] = inputData[key];
            hasChanges = true;
        }
    }
    
    if (!hasChanges) {
        return showToast("No changes to save", "info");
    }
    
    try{
        const r=await fetch(UPDATE_PROFILE_URL,{method:"PUT",headers:{"Authorization":"Bearer "+t,"Content-Type":"application/json"},body:JSON.stringify(upd)});
        const res=await r.json();
        if(r.status===200&&res.status===1){
            // Manually update localStorage user object
            const newUser = { ...u, ...upd };
            localStorage.setItem("user", JSON.stringify(newUser));
            
            await fetchProfile(); // Ensure latest data from server (optional but good for syncing other fields)
            showToast("Profile updated","success");
            viewProfile(); // Refresh modal data and keep open
        }else showToast(res.message||"Update failed","error");
    }catch(e){showToast("Network error","error")}
}

function viewLoginDetails() {
    const u = JSON.parse(localStorage.getItem("user"));
    if (!u) return;
    const fields = [
        { key: "username", label: "Username", val: u.username || "" },
        { key: "password", label: "Password", val: "********", isPassword: true },
        { key: "email", label: "Email", val: u.email || "" },
        { key: "mobile", label: "Mobile", val: u.mobile || "" }
    ];
    
    const container = document.getElementById("login-details-container");
    container.innerHTML = fields.map(f => `
        <div class="login-detail-row" id="row-${f.key}">
            <div class="login-detail-label">${f.label}</div>
            <div class="login-detail-value" id="view-${f.key}">
                <span id="txt-${f.key}">${f.val}</span>
                <button class="btn btn-ghost" style="padding:0.25rem 0.5rem" onclick="toggleEditLoginDetail('${f.key}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
            </div>
            <div class="login-detail-actions" id="edit-${f.key}" style="display:none;align-items:center;flex-grow:1;justify-content:flex-end;gap:0.5rem">
                <div class="input-wrapper" style="margin:0;width:auto;flex-grow:1;position:relative">
                    <input type="${f.isPassword ? 'password' : 'text'}" id="input-${f.key}" value="${f.isPassword ? '' : f.val}" placeholder="${f.label}" style="padding:0.25rem 0.5rem;font-size:0.875rem">
                    <button class="clear-icon" onclick="document.getElementById('input-${f.key}').value=''" style="right:0.25rem">✕</button>
                </div>
                <button class="btn btn-ghost" style="padding:0.25rem 0.5rem;color:#22c55e" onclick="saveLoginDetail('${f.key}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                </button>
                <button class="btn btn-ghost" style="padding:0.25rem 0.5rem;color:#ef4444" onclick="toggleEditLoginDetail('${f.key}', false)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
        </div>
    `).join("");
    
    document.getElementById("login-details-modal").classList.add("active");
    document.getElementById("profile-menu").classList.remove("active");
}

function toggleEditLoginDetail(key, showEdit = true) {
    document.getElementById(`view-${key}`).style.display = showEdit ? "none" : "flex";
    document.getElementById(`edit-${key}`).style.display = showEdit ? "flex" : "none";
}

async function saveLoginDetail(key) {
    const val = document.getElementById(`input-${key}`).value.trim();
    if (!val && key !== 'email' && key !== 'mobile') return showToast(`${key} cannot be empty`, "error");
    
    const u = JSON.parse(localStorage.getItem("user")), t = localStorage.getItem("token");
    if (!u || !t) return;
    
    const payload = { id: u.id, [key]: val };
    const url = key === 'password' ? `${UPDATE_PROFILE_URL}&is_serialize=1` : UPDATE_PROFILE_URL;
    
    try {
        const r = await fetch(url, {
            method: "PUT",
            headers: { "Authorization": "Bearer " + t, "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const res = await r.json();
        if (r.status === 200 && res.status === 1) {
            // Manually update localStorage user object
            if (key !== "password") {
                const newUser = { ...u, [key]: val };
                localStorage.setItem("user", JSON.stringify(newUser));
            }

            if (key !== "password") await fetchProfile();
            showToast(`${key} updated successfully`, "success");
            viewLoginDetails();
        } else {
            showToast(res.message || "Update failed", "error");
        }
    } catch (e) {
        showToast("Network error", "error");
    }
}

async function deleteAccount(){
    const t=localStorage.getItem("token");
    if(!t)return;
    try{
        const r=await fetch(DELETE_ACCOUNT_URL,{method:"DELETE",headers:{"Authorization":"Bearer "+t}});
        const res=await r.json();
        if(r.status===200&&res.status===1){
            document.getElementById("delete-account-modal").classList.remove("active");
            showToast("Account deleted successfully","success");
            logout();
        }else showToast(res.message||"Delete failed","error");
    }catch(e){showToast("Network error","error")}
}

function togglePassword(id, btn){
    const i=document.getElementById(id);
    if(i.type==="password"){
        i.type="text";
        btn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
    }else{
        i.type="password";
        btn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
    }
}
</script>
</body>
</html>