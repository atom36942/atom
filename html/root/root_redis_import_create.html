<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Redis Import Create</title>

<style>
  :root{
    --bg:#0b0d10; --card:#0f1114; --muted:#9aa0a6;
    --primary:#38a169; --primary-text:#031013;
    --secondary:#1f2933; --secondary-text:#e6eef3;
  }

  html,body{
    margin:0;
    background:var(--bg);
    color:#e6eef3;
    font-family:Inter,system-ui;
  }

  .container{
    max-width:640px;
    margin:32px auto;
    padding:16px;
  }

  .card{
    background:var(--card);
    border-radius:10px;
    padding:22px;
    box-shadow:0 4px 18px rgba(0,0,0,.5);
  }

  h1{margin:0;font-size:18px;}

  .card-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
  }

  .token-input{
    padding:8px 12px;
    font-size:13px;
    border-radius:6px;
    border:1px solid rgba(255,255,255,.08);
    background:#0b0d10;
    color:#e6eef3;
    width:200px;
    box-sizing:border-box;
  }

  form{
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  input{
    width:100%;
    padding:14px;
    font-size:15px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,.05);
    background:#0b0d10;
    color:#e6eef3;
    box-sizing:border-box;
  }

  input[type="file"]{
    padding:10px 14px;
    cursor:pointer;
  }

  input[type="file"]::file-selector-button{
    background:#2d2f33;
    color:#e6eef3;
    border:none;
    padding:8px 14px;
    border-radius:6px;
    cursor:pointer;
    margin-right:10px;
  }

  .row{
    display:flex;
    justify-content:space-between;
    gap:14px;
    margin-top:4px;
  }

  .btn{
    padding:12px;
    flex:1;
    text-align:center;
    font-size:14px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    box-sizing:border-box;
  }

  .btn-primary{background:var(--primary);color:var(--primary-text);}
  .btn-secondary{background:var(--secondary);color:var(--secondary-text);}
  .btn:disabled{opacity:.6;}

  .resp-box{
    background:#1a1c1f;
    border-radius:8px;
    margin-top:20px;
    display:none;
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
  }

  td{
    padding:12px;
    border-bottom:1px solid #333;
  }

  .key{color:#9aa0a6;width:110px;}
  .val{word-break:break-all;max-width:300px;}

  .copy-btn{
    background:#2d2f33;
    color:#ccc;
    border:none;
    padding:6px 10px;
    border-radius:6px;
    cursor:pointer;
    font-size:12px;
  }
</style>
</head>

<body>
<div class="container">
  <div class="card">

    <div class="card-header">
      <h1>Redis Import Create</h1>
      <input id="token_root" class="token-input" placeholder="token_root" />
    </div>

    <form id="redisForm">
      <input id="table" placeholder="table (ex: test)" required />
      <input id="expiry_sec" type="number" placeholder="expiry_sec (ex: 100)" required />
      <input id="file" type="file" accept=".csv" required />

      <div class="row">
        <button id="clearBtn" type="button" class="btn btn-secondary">Clear</button>
        <button id="submitBtn" type="submit" class="btn btn-primary">Submit</button>
      </div>
    </form>

    <div class="resp-box" id="respBox">
      <table id="respTable"></table>
    </div>

  </div>
</div>

<script>
(function(){

  const form = document.getElementById("redisForm");
  const submitBtn = document.getElementById("submitBtn");
  const clearBtn = document.getElementById("clearBtn");
  const respBox = document.getElementById("respBox");
  const respTable = document.getElementById("respTable");

  clearBtn.addEventListener("click", ()=>{
    form.reset();
    document.getElementById("token_root").value = "";
    respBox.style.display = "none";
    respTable.innerHTML = "";
  });

  function renderResponse(json){
    respTable.innerHTML = "";

    Object.entries(json).forEach(([k,v])=>{
      let vStr;
      if(typeof v === 'object' && v !== null){
        vStr = JSON.stringify(v, null, 2);
      } else {
        vStr = String(v);
      }
      const enc  = encodeURIComponent(vStr);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="key">${k}</td>
        <td class="val">${vStr}</td>
        <td><button class="copy-btn" data-val="${enc}">Copy</button></td>
      `;
      respTable.appendChild(tr);
    });

    respBox.style.display = "block";
  }

  // Copy delegate
  respTable.addEventListener("click",(e)=>{
    if(e.target.classList.contains("copy-btn")){
      const raw = decodeURIComponent(e.target.dataset.val);
      navigator.clipboard.writeText(raw);
    }
  });

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    submitBtn.disabled = true;

    const token = document.getElementById("token_root").value.trim();
    const fileInput = document.getElementById("file");
    
    // Create FormData for multipart/form-data
    const formData = new FormData();
    formData.append("table", form.table.value.trim());
    formData.append("expiry_sec", form.expiry_sec.value.trim());
    
    if(fileInput.files.length > 0){
      formData.append("file", fileInput.files[0]);
    }

    try{
      const baseurl = window.location.origin;

      const headers = {};
      if(token){
        headers["Authorization"] = "Bearer " + token;
      }

      const resp = await fetch(baseurl + "/root/redis-import-create", {
        method:"POST",
        headers: headers,
        body: formData
      });

      const raw = await resp.text();

      let json;
      try { 
        json = JSON.parse(raw);
        renderResponse({
          status: json.status !== undefined ? json.status : resp.status,
          message: json.message !== undefined ? json.message : json
        });
      }
      catch { 
        renderResponse({
          status: resp.status,
          message: raw || "Invalid response"
        });
      }

    }catch(err){
      renderResponse({
        status: 0,
        message: err.message || "error"
      });

    }finally{
      submitBtn.disabled = false;
    }
  });

})();
</script>

</body>
</html>