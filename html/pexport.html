<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Postgres Export</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1720; --muted:#9aa6b2; --accent:#7dd3fc;
      --glass: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#06080a 0%,var(--bg) 100%);font-family:Inter,ui-sans-serif,system-ui,Arial,sans-serif;color:#e6eef6}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:760px;max-width:100%;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:22px;box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0 0 14px 0;font-size:18px;font-weight:600;color:#fff}
    .row{display:flex;gap:12px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type=text], textarea, input[type=password]{
      width:100%;background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:10px 12px;border-radius:8px;color:inherit;font-size:13px;
      outline:none;resize:vertical;
    }
    textarea{min-height:120px}
    .grid{display:grid;grid-template-columns:1fr 220px;gap:12px;align-items:start;margin-bottom:12px}
    .controls{display:flex;gap:8px;align-items:center;margin-top:8px}
    button{
      background:linear-gradient(180deg,var(--accent),#38bdf8);border:0;padding:10px 14px;border-radius:8px;font-weight:600;color:#022;cursor:pointer;
      box-shadow:0 6px 18px rgba(59,130,246,0.12)
    }
    button[disabled]{opacity:0.55;cursor:default}
    .small{font-size:12px;color:var(--muted)}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
    .note{font-size:12px;color:var(--muted)}
    @media (max-width:640px){.grid{grid-template-columns:1fr;}.card{padding:16px}}
  </style>
</head>
<body>
  <div class="wrap">
    <form id="exportForm" class="card" autocomplete="off" onsubmit="return false">
      <h1>Postgres CSV Export</h1>

      <div class="grid">
        <div>
          <label for="query">SQL query</label>
          <textarea id="query" required>select 1;</textarea>
        </div>

        <div>
          <label for="token">Root token (Bearer)</label>
          <input id="token" type="password" placeholder="Paste token_root here" />
          <div style="height:8px"></div>
          <label for="filename">Download filename</label>
          <input id="filename" type="text" placeholder="export_postgres.csv" value="export_postgres.csv" />
        </div>
      </div>

      <div class="row" style="gap:12px;align-items:center">
        <div style="flex:1">
          <label>Endpoint (derived from page origin)</label>
          <input id="endpoint" type="text" readonly />
          <div class="small" style="margin-top:6px">Request will be POST to <code>/root/postgres-export</code> on the current origin.</div>
        </div>
        <div style="width:160px;display:flex;flex-direction:column;justify-content:flex-end">
          <button id="submit">Export CSV</button>
        </div>
      </div>

      <div class="footer">
        <div class="note" id="status">ready</div>
        <div class="small">CORS must allow POST and expose Content-Disposition for filename parsing.</div>
      </div>
    </form>
  </div>

  <script>
    (function(){
      const origin = window.location.origin.replace(/\/$/,'');
      const endpointEl = document.getElementById('endpoint');
      const tokenEl = document.getElementById('token');
      const queryEl = document.getElementById('query');
      const submit = document.getElementById('submit');
      const status = document.getElementById('status');
      const filenameEl = document.getElementById('filename');

      endpointEl.value = origin + '/root/postgres-export';

      function setStatus(txt, err){
        status.textContent = txt;
        status.style.color = err ? '#ffb4b4' : '#9cc6d9';
      }

      async function doExport(){
        const token = tokenEl.value.trim();
        if(!token){ setStatus('token required', true); return; }
        const q = queryEl.value.trim();
        if(!q){ setStatus('query required', true); return; }

        submit.disabled = true;
        setStatus('requesting...');

        try{
          const res = await fetch(origin + '/root/postgres-export', {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'Authorization':'Bearer ' + token
            },
            body: JSON.stringify({ query: q })
          });

          if(!res.ok){
            const txt = await res.text().catch(()=>res.statusText);
            setStatus('error: '+res.status+' '+txt, true);
            submit.disabled = false;
            return;
          }

          const blob = await res.blob();
          let filename = filenameEl.value.trim() || 'export_postgres.csv';

          // try parse filename from Content-Disposition
          const cd = res.headers.get('Content-Disposition') || res.headers.get('content-disposition');
          if(cd){
            const m = /filename\*=UTF-8''([^;]+)|filename="([^"]+)"|filename=([^;]+)/i.exec(cd);
            if(m){
              filename = decodeURIComponent(m[1] || m[2] || m[3]) || filename;
            }
          }

          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);

          setStatus('download started â€” ' + filename);
        }catch(err){
          setStatus('network/error: ' + (err.message || err), true);
        }finally{
          submit.disabled = false;
        }
      }

      submit.addEventListener('click', doExport);
      // allow ctrl+enter to submit from textarea
      queryEl.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key==='Enter') doExport(); });
    })();
  </script>
</body>
</html>
