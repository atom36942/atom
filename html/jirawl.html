<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jira Worklog Export</title>
<style>
  :root{
    --bg:#0b0d10; --card:#0f1114; --muted:#9aa0a6;
    --primary:#38a169; --primary-text:#031013;
    --secondary:#1f2933; --secondary-text:#e6eef3;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#070708);color:#e6eef3;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;}
  .container{max-width:640px;margin:32px auto;padding:20px;}
  .card{background:var(--card);border-radius:10px;padding:28px;box-shadow:0 6px 24px rgba(0,0,0,.6);}
  h1{margin:0 0 18px;font-size:18px;font-weight:600;color:#fff}
  form{display:flex;flex-direction:column;gap:14px}
  label{font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="text"], input[type="email"], input[type="password"], input[type="date"]{
    width:100%;padding:18px 14px;font-size:16px;border-radius:8px;border:1px solid rgba(255,255,255,.04);
    background:#0b0d10;color:#e6eef3;outline:none;box-sizing:border-box;
  }
  .input-group{position:relative;display:flex;align-items:center;}
  .toggle-visibility{
    position:absolute;right:12px;cursor:pointer;color:var(--muted);
    background:none;border:none;padding:0;
  }
  .toggle-visibility:hover{color:#fff;}
  .row{display:flex;gap:12px}
  .row > *{flex:1}
  .btn{margin-top:6px;padding:14px;font-size:15px;border-radius:10px;border:none;cursor:pointer}
  .btn-primary{background:var(--primary);color:var(--primary-text);}
  .btn-secondary{background:var(--secondary);color:var(--secondary-text);}
  .btn:disabled{opacity:.6;cursor:not-allowed;}
  .small{font-size:13px;color:var(--muted);text-align:center;margin-top:12px}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>Jira Worklog Export</h1>
    <form id="exportForm">
      <div>
        <label for="jira_base_url">Jira Base URL</label>
        <input id="jira_base_url" name="jira_base_url" type="text" placeholder="https://yourcompany.atlassian.net" required />
      </div>
      <div>
        <label for="jira_email">Jira Email</label>
        <input id="jira_email" name="jira_email" type="email" placeholder="user@example.com" required />
      </div>
      <div>
        <label for="jira_token">Jira API Token</label>
        <div class="input-group">
          <input id="jira_token" name="jira_token" type="password" placeholder="token" required />
          <button type="button" id="toggleToken" class="toggle-visibility" aria-label="Show/Hide token">
            üëÅÔ∏è
          </button>
        </div>
      </div>
      <div>
        <label for="start_date">Start Date</label>
        <input id="start_date" name="start_date" type="text" placeholder="YYYY-MM-DD" required />
      </div>
      <div>
        <label for="end_date">End Date</label>
        <input id="end_date" name="end_date" type="text" placeholder="YYYY-MM-DD" required />
      </div>
      <div class="row">
        <button id="clearBtn" type="button" class="btn btn-secondary">Clear</button>
        <button id="submitBtn" type="submit" class="btn btn-primary">Export CSV</button>
      </div>
    </form>
    <div class="small" id="status"></div>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('exportForm');
  const status = document.getElementById('status');
  const clearBtn = document.getElementById('clearBtn');
  const submitBtn = document.getElementById('submitBtn');
  const toggleBtn = document.getElementById('toggleToken');
  const tokenInput = document.getElementById('jira_token');
  const startDateInput = document.getElementById('start_date');
  const endDateInput = document.getElementById('end_date');

  // set default start and end dates to current month (values work for text inputs too)
  const now = new Date();
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  startDateInput.value = firstDay.toISOString().split('T')[0];
  endDateInput.value = lastDay.toISOString().split('T')[0];

  clearBtn.addEventListener('click', ()=>{ form.reset(); status.textContent=''; });

  toggleBtn.addEventListener('click', ()=>{
    if(tokenInput.type === 'password'){
      tokenInput.type = 'text';
      toggleBtn.textContent = 'üôà';
    } else {
      tokenInput.type = 'password';
      toggleBtn.textContent = 'üëÅÔ∏è';
    }
  });

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    status.textContent = 'Working...';
    submitBtn.disabled = true;
    const data = {
      jira_base_url: form.jira_base_url.value.trim(),
      jira_email: form.jira_email.value.trim(),
      jira_token: form.jira_token.value.trim(),
      start_date: form.start_date.value,
      end_date: form.end_date.value
    };
    try{
      const baseurl = window.location.origin;
      const resp = await fetch(baseurl + '/public/jira-worklog-export', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      if(!resp.ok) throw new Error('HTTP ' + resp.status);
      const blob = await resp.blob();
      const cd = resp.headers.get('content-disposition') || '';
      const match = cd.match(/filename\*?=(?:UTF-8'')?["']?([^;"']+)["']?/i);
      const filename = match ? decodeURIComponent(match[1]) : 'export_jira_worklog.csv';
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
      status.textContent = 'Downloaded: ' + filename;
    }catch(err){
      console.error(err);
      status.textContent = 'Error: ' + (err.message || err);
    }finally{
      submitBtn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
